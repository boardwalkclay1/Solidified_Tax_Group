<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sign Document â€“ Solidified Tax Group</title>
  <link rel="stylesheet" href="styles/style.css" />
</head>

<body>

<header class="topbar">
  <div class="st-logo">
    <span class="st-s">S</span>
    <span class="st-t">T</span>
    <span class="st-dot-left"></span>
    <span class="st-dot-top"></span>
  </div>
</header>

<main class="page">

  <section class="card">
    <h2>Sign Document</h2>
    <p>Review your document, sign digitally, or download and sign by hand.</p>

    <!-- DOCUMENT INFO -->
    <div id="docInfo" class="doc-info">Loading document...</div>

    <!-- DOWNLOAD BUTTON -->
    <button id="downloadDocBtn" class="btn">Download Document</button>

    <!-- SIGNATURE SECTION -->
    <h3 class="sig-title">Digital Signature</h3>

    <div class="signature-container">
      <canvas id="signaturePad"></canvas>
    </div>

    <div class="signature-actions">
      <button id="clearSigBtn" class="btn secondary">Clear</button>
      <button id="saveSigBtn" class="btn">Save Signature</button>
    </div>
  </section>

</main>

<script>
/* ---------------------------------------------------------
   GET QUERY PARAM
--------------------------------------------------------- */
function getQueryParam(name) {
  const params = new URLSearchParams(window.location.search);
  return params.get(name);
}

/* ---------------------------------------------------------
   LOAD DOCUMENT INFO
--------------------------------------------------------- */
let docId = null;
let doc = null;

async function loadDocumentInfo() {
  docId = getQueryParam("docId");

  if (!docId) {
    document.getElementById("docInfo").innerHTML = "<p>Missing document ID.</p>";
    return;
  }

  const res = await fetch(`/api/documents/${docId}`);
  const data = await res.json();

  if (!data || data.error) {
    document.getElementById("docInfo").innerHTML = "<p>Document not found.</p>";
    return;
  }

  doc = data;

  document.getElementById("docInfo").innerHTML = `
    <p><strong>${doc.originalName}</strong><br/>
    Uploaded: ${new Date(doc.uploadedAt).toLocaleDateString()}</p>
  `;

  document.getElementById("downloadDocBtn").onclick = () => {
    window.location.href = "/uploads/" + doc.filename;
  };
}

/* ---------------------------------------------------------
   SIGNATURE PAD (Responsive)
--------------------------------------------------------- */
function initSignaturePad() {
  const canvas = document.getElementById("signaturePad");
  const ctx = canvas.getContext("2d");

  function resizeCanvas() {
    const container = document.querySelector(".signature-container");
    canvas.width = container.offsetWidth;
    canvas.height = 220;
    ctx.lineWidth = 2;
    ctx.strokeStyle = "#000";
  }

  resizeCanvas();
  window.addEventListener("resize", resizeCanvas);

  let drawing = false;
  let lastX = 0;
  let lastY = 0;

  function start(e) {
    drawing = true;
    const rect = canvas.getBoundingClientRect();
    lastX = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    lastY = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
  }

  function draw(e) {
    if (!drawing) return;
    const rect = canvas.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;

    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();

    lastX = x;
    lastY = y;
  }

  function stop() {
    drawing = false;
  }

  // Mouse
  canvas.addEventListener("mousedown", start);
  canvas.addEventListener("mousemove", draw);
  canvas.addEventListener("mouseup", stop);
  canvas.addEventListener("mouseout", stop);

  // Touch
  canvas.addEventListener("touchstart", start);
  canvas.addEventListener("touchmove", draw);
  canvas.addEventListener("touchend", stop);

  document.getElementById("clearSigBtn").onclick = () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  };

  document.getElementById("saveSigBtn").onclick = async () => {
    if (!docId) return alert("No document loaded.");

    const dataUrl = canvas.toDataURL("image/png");

    const res = await fetch(`/api/documents/${docId}/sign`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ signatureDataUrl: dataUrl })
    });

    const result = await res.json();

    if (!result.success) {
      alert("Failed to save signature.");
      return;
    }

    alert("Signature saved successfully.");
  };
}

/* ---------------------------------------------------------
   INIT
--------------------------------------------------------- */
document.addEventListener("DOMContentLoaded", async () => {
  await loadDocumentInfo();
  initSignaturePad();
});
</script>

</body>
</html>
